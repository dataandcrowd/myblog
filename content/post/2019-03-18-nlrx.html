---
title: nlrx - The best R package for running NetLogo simulation
author: H
date: '2019-03-18'
slug: hpc
categories: 
  - R:Tips
  - NetLogo
tags:
  - R
  - NetLogo
  - nlrx
---



<div id="intro" class="section level2">
<h2>Intro</h2>
<p>From the previous blog, you might have noticed the rationale of using high performance computing (HPC), and how fast it is to obtain results compared to our local machines. Having installed all the software requirements on the HPC, today’s post is to simulate a <em>NetLogo</em> model of my Ph.D work in R using an <strong>nlrx</strong> package(<a href="https://ropensci.github.io/nlrx/" class="uri">https://ropensci.github.io/nlrx/</a>).</p>
<p><code>nlrx</code> has promoted its uniqueness for adopting <code>.XML</code> to excecute files that contain various conditions (i.e. runtime, variables, constants, stop conditions), as well as reporting results framed as a <a href="https://ccl.northwestern.edu/netlogo/docs/behaviorspace.html">BehaviorSpace format</a>. As a passionate NetLogo user, I have to give both thumbs up to this package (psst..! and removed other NetLogo packages). Here are the reasons.</p>
</div>
<div id="easy-and-intuitive-codes" class="section level2">
<h2>Easy and intuitive codes</h2>
<p><code>nlrx</code> introduces codes that are catchy and intuitive. Here is a brief example of my model on Windows. If you want a model embedded in the NetLogo library, please refer to the nlrx website.
Prior to loading your model, you have to follow 3 steps: 1) install package(we will skip that), 2) setup, and 3) assign variables and conditions.</p>
<div id="setup-in-r" class="section level3">
<h3>Setup in R</h3>
<p>After the installation, your job is to assign your paths correctly. You will need to assign paths for Java, NetLogo, model files, and simulation output. In my case, I wrote the absolute paths to avoid error since softwares and the model are saved in different directories. I use NetLogo 6.0.4, but anyone who is using a different version can modify the version name.</p>
<pre><code>#devtools::install_github(&quot;ropensci/nlrx&quot;)
library(nlrx)

# Java setup
Sys.setenv(JAVA_HOME=&#39;C:/Program Files/Java/jdk1.8.0_202/jre&#39;)

# Assign Path
netlogopath &lt;- file.path(&quot;C:/Program Files/NetLogo 6.0.4&quot;)
outpath &lt;- file.path(&quot;d:/out&quot;)

# Create nl variable
nl &lt;- nl(nlversion = &quot;6.0.4&quot;,
         nlpath = netlogopath,
         modelpath = file.path(&quot;D:/github/jasss/Gangnam_v6.nlogo&quot;),
         jvmmem = 1024)</code></pre>
</div>
<div id="create-experiment" class="section level3">
<h3>Create experiment</h3>
<p>Now the experiment is where the central function has to be properly defined. That is, you will need to decide everything that you’ve set in your model. Here is a list of questions:</p>
<ul>
<li><code>expname</code>: What is the name of your experiment?</li>
<li><code>outpath</code>: What is the name of your output path?</li>
<li><code>repetition</code>: How many repetitions you want to run?</li>
<li><code>tickmetrics</code>: Would you like to activate ticks?</li>
<li><code>idsetup</code>: Setup button of your model</li>
<li><code>idgo</code>: Go button of your model</li>
<li><code>runtime</code>: How many ticks to run (in your model)? <em>e.g. 8764</em></li>
<li><code>evalticks</code>: Specifying ticks to report. <em>I wanted to capture agent’s personal info in every 100 ticks.</em></li>
<li><code>constants</code>: What is your fixed parameters. <em>pollution standard, pollution scenario (make sure you put your strings inside the backslash!)</em></li>
<li><code>variables</code>: list of changable parameters. <em>I used factoral variables</em></li>
<li><code>metrics.turtles</code>: turtles and their attributes</li>
<li><code>metrics.patches</code>: patches and their attributes</li>
<li><code>stopcond</code>: When you need stop conditions</li>
</ul>
<p>Once every parameter are written, you can test if the model is valid to run the simulation. The package uses <code>eval_variables_constants(nl)</code>, and the command will return wheter it is valid or not. Then, we give a simple design <code>simdesign_simple()</code> where constants are used. Finally, with the <code>run_nl_all()</code> command, the model will execute and assign it in the R global environment as result. A kind note is that the <code>result</code> variable is a nested data frame which is heavy and needs to be unnested.</p>
<pre><code>nl@experiment &lt;- experiment(expname = &quot;seoul&quot;,
                            outpath = outpath,
                            repetition = 1,   
                            tickmetrics = &quot;true&quot;,
                            idsetup = &quot;setup&quot;,  
                            idgo = &quot;go&quot;,        
                            runtime = 8764,
                            evalticks=seq(1,8764, by = 100),
                            constants = list(&quot;PM10-parameters&quot; = 100,
                                             &quot;Scenario&quot; = &quot;\&quot;BAU\&quot;&quot;,
                                             &quot;scenario-percent&quot; = &quot;\&quot;inc-sce\&quot;&quot;),
                            variables = list(&#39;AC&#39; = list(values=c(100,150,200))),
                            metrics.turtles =  list(&quot;turtles&quot; = c(&quot;pxcor&quot;, &quot;pycor&quot;, &quot;color&quot;, &quot;heading&quot;, &quot;who&quot;, 
                                                 &quot;homename&quot;, &quot;destinationName&quot;, &quot;age&quot;, &quot;health&quot;)),
                            metrics.patches = c(&quot;pxcor&quot;, &quot;pycor&quot;, &quot;pcolor&quot;))

# Evaluate if variables and constants are valid:
eval_variables_constants(nl)
nl@simdesign &lt;- simdesign_simple(nl = nl, nseeds = 1)

# Run Simulation
init &lt;- Sys.time()
results &lt;- run_nl_all(nl = nl)
Sys.time() - init</code></pre>
<p>In short, I think that the developers have made the commands concise and understandable to users in any level.</p>
</div>
</div>
<div id="small-file-size" class="section level2">
<h2>Small file size</h2>
<p>Another part, which might seem less important but is actually not, is the file size. On the previous section, I mentioned that it runs on a XML file and the results is given as a nested data frame. Surprisingly, the <code>.RData</code> of my simulation result is only 24MB although I have to acknowledge that it took more than 10GB of your memory during the process. Thus if any of you are running NetLogo on Windows, then the first thing you need to do is to increase your virtual memory <code>memory.limit(size = 99999)</code>. If you are using Linux or Mac, I really wish you have a good storage of RAM with a generously allocated swap space to run expensive models.</p>
<p>Compared to nlrx, <a href="http://rnetlogo.r-forge.r-project.org/">RNetLogo</a> has a <code>while</code> command that records your global variables as a data frame. It used to be good, but they had problems to assigning <em>string</em> variables , which made the user convert it in NetLogo and comback to R for implementation. Moreover, RNetLogo’s <code>.RData</code> was more than a 100MB for a single iteration which is okay for a local machine, but might be quite excessive if you are working with peers on a version control.</p>
</div>
<div id="direct-codes-for-plot-and-animation" class="section level2">
<h2>Direct codes for plot and animation</h2>
<p><del>Plotting on ggplot2 is under construction</del></p>
</div>
<div id="parallelising" class="section level2">
<h2>Parallelising</h2>
<p>According to the advanced configuration in R, the developers found ways to parallelise netlogo using the <code>future_map_dfr()</code> function from the furrr package. So once you’ve downloaded nlrx package, dependency packages are also installed.</p>
<pre><code>library(future)
plan(&quot;multisession&quot;)
results %&lt;-% run_nl_all(nl = nl, split = 4)
</code></pre>
</div>
