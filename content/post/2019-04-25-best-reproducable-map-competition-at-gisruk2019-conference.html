---
title: Best Reproducable Map competition @GISRUK2019
author: ''
date: '2019-04-25'
slug: gisruk2019
categories:
  - R:Tips
  - R
tags:
  - Kriging
---



<p>Just before the GISRUK2019 conference, a mapping competition was announced by Robin Lovelace who was one of the instructors in the Spatial data in R workshop. I was keen on participating this competition because I use <code>R</code> and <code>GIS</code> for my PhD project, and there were some outcomes that I could use for the challenge. However, my confidence slowly diminished after I spotted the title <strong>Reproducable</strong> after the <em>Best</em>. What does this mean? For me it meant transparent first, and good-looking next.</p>
<p>And…guess what? I won the competition! Yey! <br> Take a look at my Kriging map of NO2 interpolation.</p>
<p><img src="/images/no2.png" /></p>
<p>If you are interested in how I made this journey, you can follow my narratives below. <br>
If you want to want to know more about spatial interpolation and pollution, leave me a tweet <code>@hyesop</code>.</p>
<div id="tidy-data" class="section level2">
<h2>Tidy data</h2>
<p>First and foremost, my initial job was to clean my untidied chunks of codes. That is, to separate paragrahs and put approrpiate indentation (<code>ctrl + I</code> / <code>cmd + I</code>) for each code chunk. I also added some annotation to give some help.</p>
</div>
<div id="upload-to-my-github-repository-and-add-codes-for-auto-implementation" class="section level2">
<h2>Upload to my Github repository and add codes for auto-implementation</h2>
<p>Now, the next question, how do I upload my files on a public repository so that everyone can automatically download and run the simulation? There are various ways to solve this question, but my choice was to use my <strong>Github</strong> repository. To make things reproducible, this is how my code ended up…</p>
<pre class="r"><code>options(scipen = 100) # To see long decimal points
memory.size() # for WindowsOS
memory.limit(99999) # for WindowsOS

library(tidyverse)
library(sf)
library(raster)
library(rgdal)
library(automap)
library(gridExtra)


# set working directory so I know where the .zip file will be located
getwd()
#setwd(dir = &quot;/some/path/&quot;)

# on the GitHub repository of interest
download.file(url = &quot;https://github.com/mrsensible/GISRUK2019/archive/master.zip&quot;, 
              destfile = &quot;GISRUK2019-master.zip&quot;)

# unzip the .zip file
unzip(zipfile = &quot;GISRUK2019-master.zip&quot;)

# examine the contents
list.files(&#39;./GISRUK2019-master&#39;)
list.files(&#39;./GISRUK2019-master/data&#39;)

# Set Workding Directory
setwd(&#39;./GISRUK2019-master&#39;)


# Load NO2 Pollution data
load(&quot;data/no2_jan.RData&quot;)

# Import moritoring stations from Seoul
stations &lt;- read_sf(&quot;data/stations_10km.shp&quot;)
stations_df &lt;- stations %&gt;% st_set_geometry(NULL)

# Import Seoul Shapefile
seoul &lt;- read_sf(&quot;data/Seoul_City.shp&quot;) %&gt;% as(&#39;Spatial&#39;) %&gt;% fortify()

no2.winter &lt;- merge(no2.win.12hr, stations_df, by.x = c(&quot;Station.ID&quot;, &quot;X&quot;, &quot;Y&quot;), by.y = c(&quot;Station&quot;, &quot;X&quot;, &quot;Y&quot;))
coordinates(no2.winter) &lt;- ~X+Y
proj4string(no2.winter) &lt;- CRS(&quot;+init=epsg:5181&quot;)


#--Put Multiple Plots on a Single Page in R with spplot--##
plots &lt;- lapply(names(no2.winter)[3:22], function(.x) spplot(no2.winter,.x))
do.call(grid.arrange,plots)


#################################################################
#--Generate auto Semivariograms in need to create Kriging maps--#
#################################################################
myList &lt;- list()

for(i in 1:20) { 
  myList[[length(myList)+1]] &lt;- autofitVariogram(no2.winter[[i+2]] ~ 1, no2.winter)
}
semvar &lt;- lapply(myList, function(x) plot(x))
do.call(grid.arrange, semvar[1:4])


### Create gridcells for interpolation
seoul_grid &lt;- data.frame(expand.grid(X = seq(min(no2.winter$X), max(no2.winter$X), length=200),
                                     Y = seq(min(no2.winter$Y), max(no2.winter$Y), length=200)))
coordinates(seoul_grid) &lt;- ~X+Y
proj4string(seoul_grid) &lt;- CRS(&quot;+init=epsg:5181&quot;) #Korean Central Belt 2000


##############
#--Kriging--##
##############
sum.squares &lt;- vector()
var.model &lt;- data.frame()
pred.model &lt;- seoul_grid@coords


# This iteration takes 5 minutes!!

for(i in 1:20) {
  kriging_new &lt;- autoKrige(no2.winter@data[,i+2]~ X + Y,
                           nmax = 20000,
                           input_data = no2.winter, 
                           new_data = seoul_grid)
  sum.squares &lt;- append(sum.squares, kriging_new$sserr)
  kriging_new$var_model &lt;- data.frame(y=i,kriging_new$var_model)
  var.model &lt;- rbind(var.model, kriging_new$var_model)
  xyz &lt;- as.data.frame(kriging_new$krige_output)
  p &lt;- data.frame(xyz[,&#39;var1.pred&#39;])
  colnames(p) &lt;- colnames(no2.winter@data)[i+2]
  pred.model &lt;- cbind(pred.model, p)
} 

##-- Add ColNames
colnames(pred.model) &lt;- c(&quot;X&quot;, &quot;Y&quot;, &quot;jan01d&quot;, &quot;jan01n&quot;, &quot;jan02d&quot;, &quot;jan02n&quot;,&quot;jan03d&quot;, &quot;jan03n&quot;, &quot;jan04d&quot;, &quot;jan04n&quot;, &quot;jan05d&quot;, &quot;jan05n&quot;, &quot;jan06d&quot;, &quot;jan06n&quot;, &quot;jan07d&quot;, &quot;jan07n&quot;, &quot;jan08d&quot;, &quot;jan08n&quot;, &quot;jan09d&quot;, &quot;jan09n&quot;, &quot;jan10d&quot;, &quot;jan10n&quot;)


##-- Mean and variance to display on map
stat &lt;- pred.model %&gt;% dplyr::select(-c(X,Y)) %&gt;% 
        gather(factor_key = T) %&gt;% 
        group_by(key) %&gt;% summarise(mean= round(mean(value),1), sd= round(sd(value),1), 
                                    max = max(value),min = min(value)) %&gt;% 
        rename(Hour = key)

##############################################
##-- Final Map: Kriging Interpolation map --##
##############################################

ras.krige.df &lt;- pred.model %&gt;% 
  reshape2::melt(id = c(&quot;X&quot;, &quot;Y&quot;), variable.name = &quot;Hour&quot;, value.name = &quot;NO2&quot;) 

ras.krige.df %&gt;% 
  ggplot() +
  geom_tile(aes(x = X, y = Y, fill = NO2)) +
  scale_fill_distiller(palette = &quot;Spectral&quot;, na.value = NA, limits = c(0,125), breaks = c(0,25,50,75,100,125)) +
  geom_contour(aes(x = X, y = Y, z = NO2),bins = 20, colour = &quot;grey40&quot;, alpha = 0.7) +
  geom_path(data = seoul, aes(x = long, y = lat), color = &#39;black&#39;, size = 1) +
  geom_text(data = stat, aes(x = 187000,  y = 434000, label = paste0(&quot;mean = &quot; , mean)), size = 3) + 
  geom_text(data = stat, aes(x = 184000,  y = 430500, label = paste0(&quot;sd = &quot; , sd)), size = 3) + 
  labs(title = &quot;Kriging Interpolation for NO2 Mapping: An example of Seoul&quot;, 
       subtitle = &quot;Hourly data aggregated to Days and Nights&quot;) +
  facet_wrap(~ Hour, ncol = 8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        strip.text.x = element_text(size = 20),
        legend.title=element_text(size=15), 
        legend.text=element_text(size=15)                                  
  ) -&gt; final # 1200 x 550 


# Export PNG
png(&quot;no2_seoul.png&quot;, width=1200, height=550, res=100)
final
dev.off()

# RMSE
RMSE &lt;- function(observed, predicted) {
  sqrt(mean((predicted - observed)^2, na.rm=TRUE))}

for (i in 3:length(pred.model)){
  RMSE(mean(pred.model[, i]), pred.model[, i]) %&gt;% print()
}


# convert to Raster Bricks
krige &lt;- rasterFromXYZ(pred.model, 
                       crs=&quot;+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=500000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs&quot;,
                       digits=5)

# Write Raster
writeRaster(krige, filename=&quot;seoul_no2_multilayer.tif&quot;, options=&quot;INTERLEAVE=BAND&quot;, overwrite=TRUE)</code></pre>
</div>
<div id="where-to-find-data-and-results" class="section level2">
<h2>Where to find data and results?</h2>
<p><a href="https://github.com/Robinlovelace/geocompr/issues/376#issuecomment-486105726">Visit: Hyesop Shin’:’s Best reproducible map competition for GISRUK 2019</a>
<a href="https://github.com/mrsensible/GISRUK2019">Visit: Hyesop’s Repo</a></p>
<p><a href="https://github.com/Robinlovelace/geocompr/issues/376">Visit: Others Best reproducible map competition for GISRUK 2019</a></p>
</div>
<div id="some-tweets" class="section level2">
<h2>Some tweets</h2>
<p>{{% tweet "1121114601414901764" %}}{{% tweet "1121069825361620993" %}}</p>
</div>
